# 单元测试执行指南

## 一、测试文件结构

项目中的单元测试文件位于 `src/test/java` 目录下，与源代码的包结构保持一致：

```
src/test/java/
├── com/shiyi/
│   ├── config/
│   │   └── TestConfig.java                    # 测试配置类
│   ├── util/
│   │   └── TestUtils.java                     # 测试工具类
│   └── controller/
│       ├── api/                               # 门户接口测试
│       │   ├── ApiArticleControllerTest.java
│       │   ├── ApiUserControllerTest.java
│       │   ├── ApiAiControllerTest.java
│       │   ├── ApiUserArticleControllerTest.java
│       │   ├── ApiCommentControllerTest.java
│       │   ├── ApiCategoryControllerTest.java
│       │   ├── ApiTagsControllerTest.java
│       │   └── ApiHomeControllerTest.java
│       └── system/                            # 系统管理接口测试
│           ├── LoginControllerTest.java
│           ├── ArticlesControllerTest.java
│           ├── CategoryControllerTest.java
│           └── TagsControllerTest.java
```

## 二、测试框架和依赖

项目使用以下测试框架：

- **JUnit 5**：单元测试框架
- **Mockito**：Mock框架，用于模拟依赖对象
- **Spring Boot Test**：Spring Boot测试支持

依赖已在 `pom.xml` 中配置：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>
```

## 三、测试执行步骤

### 方式一：使用Maven命令执行测试

#### 1. 执行所有测试

```bash
mvn test
```

#### 2. 执行指定包的测试

```bash
# 执行所有API接口测试
mvn test -Dtest=com.shiyi.controller.api.*

# 执行所有系统管理接口测试
mvn test -Dtest=com.shiyi.controller.system.*

# 执行指定测试类
mvn test -Dtest=ApiArticleControllerTest
```

#### 3. 执行指定测试方法

```bash
mvn test -Dtest=ApiArticleControllerTest#testSelectPublicArticleList_Success
```

#### 4. 跳过测试（仅编译）

```bash
mvn clean package -DskipTests
```

#### 5. 生成测试报告

```bash
mvn test surefire-report:report
```

测试报告位置：`target/site/surefire-report.html`

### 方式二：使用IDE执行测试

#### IntelliJ IDEA

1. **运行单个测试类**
   - 右键点击测试类文件
   - 选择 `Run 'TestClassName'`

2. **运行单个测试方法**
   - 点击测试方法左侧的绿色运行按钮
   - 或右键方法名选择 `Run 'methodName()'`

3. **运行所有测试**
   - 右键点击 `src/test/java` 目录
   - 选择 `Run 'All Tests'`

4. **查看测试结果**
   - 在底部 `Run` 窗口查看测试结果
   - 绿色表示通过，红色表示失败

#### Eclipse

1. **运行测试**
   - 右键点击测试类或方法
   - 选择 `Run As` → `JUnit Test`

2. **查看测试结果**
   - 在 `JUnit` 视图中查看测试结果

### 方式三：使用命令行（JUnit Console Launcher）

```bash
# 编译测试代码
mvn test-compile

# 运行测试（需要配置classpath）
java -jar junit-platform-console-standalone-1.9.0.jar --class-path target/test-classes --scan-class-path
```

## 四、测试用例说明

### 测试类命名规范

- 测试类名：`被测试类名 + Test`
- 例如：`ApiArticleController` → `ApiArticleControllerTest`

### 测试方法命名规范

- 测试方法名：`test + 方法名 + _ + 场景描述`
- 例如：`testSelectPublicArticleList_Success`

### 测试结构

每个测试方法通常包含三个部分：

1. **准备（Arrange）**：准备测试数据和Mock对象
2. **执行（Act）**：调用被测试的方法
3. **验证（Assert）**：验证结果是否符合预期

示例：

```java
@Test
@DisplayName("测试获取文章列表-成功")
void testSelectPublicArticleList_Success() {
    // 1. 准备测试数据
    Integer categoryId = 1;
    Integer tagId = 2;
    ResponseResult expectedResult = ResponseResult.success("获取成功");

    // 2. 模拟Service返回
    when(articleService.selectPublicArticleList(categoryId, tagId))
            .thenReturn(expectedResult);

    // 3. 执行测试
    ResponseResult result = apiArticleController.selectPublicArticleList(categoryId, tagId);

    // 4. 验证结果
    assertNotNull(result);
    assertEquals(200, result.getCode());
    verify(articleService, times(1)).selectPublicArticleList(categoryId, tagId);
}
```

## 五、测试覆盖率

### 查看测试覆盖率

#### 使用JaCoCo插件（已配置）

项目已配置JaCoCo插件，可以直接使用：

1. **执行测试并生成覆盖率报告**：

```bash
# 清理并运行测试，自动生成覆盖率报告
mvn clean test

# 或者只运行测试（不清理）
mvn test
```

2. **查看报告**：

打开 `target/site/jacoco/index.html` 查看覆盖率报告

3. **只生成报告（不运行测试）**：

```bash
mvn jacoco:report
```

4. **检查覆盖率阈值**：

```bash
mvn jacoco:check
```

**详细说明**：请参考 `JaCoCo测试覆盖率使用指南.md` 文件

### 覆盖率目标

- **行覆盖率**：建议 ≥ 80%
- **分支覆盖率**：建议 ≥ 70%
- **方法覆盖率**：建议 ≥ 80%

## 六、常见问题解决

### 1. Windows路径过长错误

**问题**：`CreateProcess error=206, 文件名或扩展名太长。`

**原因**：Windows系统对文件路径有260字符的限制，Maven Surefire插件在执行测试时可能生成很长的类路径。

**解决方案**：

#### 方案A：已自动配置（推荐）
项目已在 `pom.xml` 中配置了Surefire插件来解决此问题，包括：
- 使用fork模式
- 设置更短的临时目录
- 缩短类路径

如果仍然遇到问题，请尝试：

#### 方案B：启用Windows长路径支持
1. 以管理员身份运行PowerShell
2. 执行：`New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWORD -Force`
3. 重启计算机

#### 方案C：使用命令行参数
```bash
mvn test -Dsurefire.useSystemClassLoader=false -Djava.io.tmpdir=C:\tmp
```

#### 方案D：缩短项目路径
将项目移动到更短的路径，例如：`C:\Projects\blog`

**详细说明**：请参考 `测试路径过长问题解决方案.md` 文件

### 2. 测试无法找到类

**问题**：`ClassNotFoundException` 或 `NoClassDefFoundError`

**解决方案**：
- 确保 `src/test/java` 目录在项目的源代码路径中
- 执行 `mvn clean test-compile` 重新编译测试代码

### 3. Mock对象未生效

**问题**：Mock对象返回null或未按预期工作

**解决方案**：
- 确保使用 `@ExtendWith(MockitoExtension.class)` 注解
- 确保使用 `@Mock` 注解标记Mock对象
- 确保使用 `@InjectMocks` 注解标记被测试对象

### 4. 测试执行缓慢

**问题**：测试执行时间过长

**解决方案**：
- 使用Mock对象替代真实的数据库、网络等外部依赖
- 避免在测试中启动完整的Spring上下文（使用Mockito而非Spring Boot Test）
- 并行执行测试：`mvn test -Dparallel=methods`

### 5. 测试结果不稳定

**问题**：同一测试有时通过有时失败

**解决方案**：
- 确保测试之间相互独立，不共享状态
- 使用 `@BeforeEach` 和 `@AfterEach` 清理测试数据
- 避免使用静态变量或单例对象

### 6. No sources to compile 错误

**问题**：执行测试时显示 `No sources to compile` 或 `No test sources to compile`

**原因**：
- 不在项目根目录（包含pom.xml的目录）下执行命令
- Maven找不到源代码目录

**解决方案**：

#### 方案A：确认执行目录（最常见）
确保在项目根目录下执行命令：
```bash
# 检查当前目录是否包含pom.xml
dir pom.xml

# 如果不在项目根目录，切换到项目根目录
cd C:\Users\C\Desktop\blog\blog-development-master\blog-development-master\blog
```

#### 方案B：清理并重新编译
```bash
mvn clean compile test-compile
mvn test
```

#### 方案C：验证项目结构
确保以下目录存在：
- `src/main/java` - 源代码目录
- `src/test/java` - 测试源代码目录

**详细说明**：请参考 `Maven编译问题解决方案.md` 文件

## 七、最佳实践

### 1. 测试独立性

- 每个测试方法应该独立运行，不依赖其他测试的执行顺序
- 使用 `@BeforeEach` 初始化测试数据，使用 `@AfterEach` 清理

### 2. 测试命名

- 使用清晰的测试方法名，描述测试的场景
- 使用 `@DisplayName` 注解提供更友好的测试描述

### 3. 测试覆盖

- 测试正常流程（Happy Path）
- 测试异常流程（Error Path）
- 测试边界条件（Boundary Conditions）

### 4. Mock使用

- 只Mock外部依赖，不Mock被测试的类本身
- 使用 `verify()` 验证方法调用次数和参数

### 5. 断言

- 使用具体的断言，而不是只检查null
- 验证返回值的所有重要属性
- 使用 `assertAll()` 组合多个断言

## 八、持续集成（CI）

### 在CI中运行测试

```yaml
# GitHub Actions 示例
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          java-version: '11'
      - name: Run tests
        run: mvn test
      - name: Generate coverage report
        run: mvn jacoco:report
```

## 九、测试报告示例

执行测试后，可以在以下位置查看测试报告：

- **Surefire报告**：`target/surefire-reports/`
- **JaCoCo覆盖率报告**：`target/site/jacoco/index.html`
- **Maven站点报告**：`target/site/surefire-report.html`

## 十、下一步

1. **完善测试用例**：为所有Controller添加完整的测试用例
2. **增加集成测试**：测试Controller与Service、Repository的集成
3. **性能测试**：添加性能基准测试
4. **自动化测试**：配置CI/CD自动运行测试

---

**注意**：本指南基于JUnit 5和Mockito框架。如果使用其他测试框架，请相应调整命令和配置。

